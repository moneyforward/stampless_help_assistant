name: Daily Git Update

# 毎日朝10時に実行（日本時間） + 手動実行可能 + プッシュ時実行
on:
  push:
    branches: [ main, master ]  # mainまたはmasterブランチへのプッシュ時
  schedule:
    - cron: '0 1 * * *'  # 毎日1時実行（UTC = 日本時間10時）
  workflow_dispatch:     # 手動実行ボタン

jobs:
  git-update:
    runs-on: ubuntu-latest

    steps:
    - name: リポジトリをチェックアウト
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 全履歴を取得

    - name: Node.js 18.x をセットアップ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 依存関係をインストール
      run: |
        npm ci

    - name: Git設定
      run: |
        git config --global user.name "Git Auto Update"
        git config --global user.email "auto-update@github.com"

    - name: Git更新実行
      run: |
        echo "📦 stampless-help-assistant リポジトリを更新します..."
        echo "現在のブランチ: $(git branch --show-current)"
        echo "最新コミット: $(git log --oneline -1)"

        # プル実行
        git pull origin main 2>/dev/null || git pull origin master 2>/dev/null || echo "プルに失敗しました"

        echo "✅ Git更新完了: $(date)"

    - name: プロジェクト構造確認
      run: |
        echo "📁 プロジェクト構造確認"
        ls -la
        echo ""
        echo "📦 package.json確認"
        cat package.json | head -20

    - name: データベース設定確認（安全な方法）
      run: |
        echo "🔍 データベース設定ファイル確認"
        if [ -f "config/database-config-simple.json" ]; then
          echo "✅ database-config-simple.json 存在します"
          echo "設定内容（一部）:"
          cat config/database-config-simple.json | head -10
        else
          echo "⚠️  database-config-simple.json が存在しません"
        fi

    - name: スクリプト実行テスト（DB接続なし）
      run: |
        echo "🧪 スクリプト実行テスト"
        echo "テスト用コマンド実行:"
        node -e "console.log('✅ Node.js実行テスト成功')"
        echo ""
        echo "利用可能なスクリプト:"
        npm run

    - name: 更新結果通知
      run: |
        echo "## stampless-help-assistant 自動更新結果" >> $GITHUB_STEP_SUMMARY
        echo "- 📅 実行日時: $(date '+%Y年%m月%d日 %H:%M')" >> $GITHUB_STEP_SUMMARY
        echo "- 📦 リポジトリ: stampless-help-assistant" >> $GITHUB_STEP_SUMMARY
        echo "- 🔧 Node.jsバージョン: $(node --version)" >> $GITHUB_STEP_SUMMARY
        echo "- 📋 npmバージョン: $(npm --version)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ ステータス: 成功" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 実行ログ" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "Git自動更新が完了しました" >> $GITHUB_STEP_SUMMARY
        echo "プロジェクト構造を確認しました" >> $GITHUB_STEP_SUMMARY
        echo "依存関係のインストールが完了しました" >> $GITHUB_STEP_SUMMARY
        echo "次回実行: 24時間後" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
